<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <meta name="application-name" content="Hydrogen Chat"/>
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <meta name="apple-mobile-web-app-title" content="Hydrogen Chat">
        <meta name="description" content="A matrix chat application">
        <link rel="apple-touch-icon" href="assets/icon-maskable.png">
        <link rel="stylesheet" type="text/css" href="src/ui/web/css/main.css">
        <link rel="stylesheet" type="text/css" href="src/ui/web/css/themes/element/theme.css" title="Element Theme">
        <link rel="alternate stylesheet" type="text/css" href="src/ui/web/css/themes/bubbles/theme.css" title="Bubbles Theme">
	</head>
	<body class="hydrogen">
        <script id="version" type="disabled">
            window.HYDROGEN_VERSION = "%%VERSION%%";
            window.HYDROGEN_GLOBAL_HASH = "%%GLOBAL_HASH%%";
        </script>
		<script id="main" type="module">
			import {main} from "./src/main.js";
			main(document.body, {
                worker: "src/worker.js",
                olm: {
                    wasm: "lib/olm/olm.wasm",
                    legacyBundle: "lib/olm/olm_legacy.js",
                    wasmBundle: "lib/olm/olm.js",
                }
            });
		</script>
        <script id="service-worker" type="module">

            function workerMessage(worker, type) {
                const body = {type, id: Math.floor(Math.random() * Number.MAX_SAFE_INTEGER)};
                let resolve;
                const promise = new Promise(r => resolve = r);
                const onMessage = function(event) {
                    if (event.data.replyTo === body.id) {
                        navigator.serviceWorker.removeEventListener("message", onMessage);
                        resolve(event.data.content);
                    }
                }
                navigator.serviceWorker.addEventListener("message", onMessage);
                worker.postMessage(body);
                return promise;
            }

            if('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').then(function(registration) {
                    console.log("Service Worker registered");
                    async function tryActivateUpdate() {
                        if (registration.waiting && registration.active) {
                            const version = await workerMessage(registration.waiting, "version");
                            if (confirm(`Version ${version.version} (${version.buildHash}) is ready to install. Apply now?`)) {
                                registration.waiting.postMessage({type: "skipWaiting"}); // will trigger controllerchange event
                            }
                        }
                    }
                    tryActivateUpdate();
                    registration.onupdatefound = function() {
                        const newWorker = registration.installing;
                        newWorker.onstatechange = function() {
                            tryActivateUpdate();
                        }
                    };
                });
                navigator.serviceWorker.addEventListener("controllerchange", function() {
                    document.location.reload();
                });
            }
        </script>
	</body>
</html>
